# 虚拟机性能监控与故障处理工具

## 4.1 概述

给一个系统定位问题时，知识、经验是关键基础，数据是依据，工具是运用知识处理数据的手段。

这里说的数据包括: 

- 运行日志
- 异常堆栈
- GC日志
- 线程快照(threaddump/javacore文件)
- 堆转储快照(heapdump/hprof)文件

## 4.2 JDK命令行工具

借助toor.jar类库里面的接口,我们可以直接在应用程序中实现功能强大的监控分析功能。

> 注:tools.jar中的类库不属于Java的标准API,如果引入这个类库,就意味着用户的程序只能运行于Sun HotSpot上面,或者部署程序时需要一起部署tools.jar

| **名称** | **主要作用**                                                 |
| -------- | ------------------------------------------------------------ |
| jps      | JVM Process Status Tool,显示指定系统内所有的HotSpot虚拟机进程 |
| jstat    | JVM statistics Monitoring Tool,用于收集HotSpot虚拟机各方面的运行数据 |
| jinfo    | Configuration Info for Java，显示虚拟机配置信息              |
| jmap     | Memory Map for Java，生成虚拟机的内存转储快照（heapdump文件） |
| jhat     | JVM Heap Dump Brower,用于分析heap dump文件，它会建立一个HTTP？HTML服务器，让用户可以在浏览器上查看分析结果 |
| jstack   | Stack Trace for Java。显示虚拟机的线程快照                   |

### 4.2.1 jps: 虚拟机进程状况工具

```shell
jps [options] [hostid]
```

| 属性 | 作用                                               |
| :--: | -------------------------------------------------- |
|  -p  | 只输出LVMID，省略主类的名称                        |
|  -m  | 输出虚拟机进程启动时传递给主类main（）函数的参数   |
|  -l  | 输出主类的全名，如果进程执行的是jar包，输出jar路径 |
|  -v  | 输出虚拟机进程启动时jvm参数                        |

### 4.2.2 jstat: 虚拟机统计信息监视工具

jstat是用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾回收、JIT编译等运行数据，在没有GUI图形界面，只是提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的首选工具。

```shell
jstat [option vmid [interval [s|ms] [count]] ]
# 参数interval 和count分别表示查询的间隔和次数，如果省略这两个参数，说明只查询一次。
```

| 选项              | 作用                                                         |
| :---------------- | ------------------------------------------------------------ |
| -class            | 监视装载类、卸载类、总空间以及类装载所耗费的时间             |
| -gc               | 监视java堆状况，包括eden区、两个survivor区、老年代、永久代等的容量、已用空间、GC时间合计信息 |
| -gccapacity       | 监视内容与-gc基本相同，但输出主要关注java堆各个区域使用到最大、最小空间 |
| -gcutil           | 监视内容与-gc基本相同，但输出主要关注已使用控件占总空间的百分比 |
| -gccause          | 与-gcutil功能一样，但是会额外输出导致上一次gc产生的原因      |
| -gcnew            | 监视新生代GC情况                                             |
| -gcnewcapacity    | 监视内容与-gcnew基本相同，输出主要关注使用到的最大、最小空间 |
| -gcold            | 监视老年代GC情况                                             |
| -gcoldcapacity    | 监视内容与-gcold基本相同，输出主要关注使用到的最大、最小空间 |
| -gcpermcapacity   | 输出永久代使用到的最大、最小空间                             |
| -compiler         | 输出JIT编译过的方法、耗时等信息                              |
| -printcompilation | 输出已经被JIT编译过的方法                                    |

### 4.2.3 jinfo: java配置信息工具

jinfo的作用是实时的查看和调整虚拟机各项参数。使用jps命令的-v参数可以查看虚拟机启动时显示指定的参数列表，但如果想知道未被显式指定的参数的系统默认值，除了去找资料以外，就得使用jinfo的-flag选项

jinfo格式 

```shell
jinfo [option] pid 
```

### 4.2.4 jmap: Java内存映像工具

jmap命令用于生成堆转储快照。jmap的作用并不仅仅为了获取dump文件，它还可以查询finalize执行队列、java堆和永久代的详细信息。如空间使用率、当前用的是哪种收集器等。

和jinfo命令一样，jmap在windows下也受到比较大的限制。除了生成dump文件的-dump选项和用于查看每个类的实例、控件占用统计的-histo选项在所有操作系用都提供之外，其余选项只能在linux/solaris下使用。

| 选项           | 作用                                                         |
| -------------- | ------------------------------------------------------------ |
| -dump          | 生成java堆转储快照。格式为： -dump:[live,]format=b,file=<filename>,其中live子参数说明是否只dump出存活的对象 |
| -finalizerinfo | 显示在F-Queue中等待Finalizer线程执行finalize方法的对象。只在Linux/Solaris平台下有效 |
| -heap          | 显示java堆详细信息，如使用哪种收集器、参数配置、分代情况等，在Linux/Solaris平台下有效 |
| -jisto         | 显示堆中对象统计信息，包含类、实例对象、合集容量             |
| -permstat      | 以ClassLoader为统计口径显示永久代内存状态。只在Linux/Solaris平台下有效 |
| -F             | 当虚拟机进程对-dump选项没有相应时。可使用这个选项强制生成dump快照。只在Linux/Solaris平台下有效 |

### 4.2.5 jhat: 虚拟机堆转储快照分析工具

Sun JDK提供jhat与jmap搭配使用，来分析dump生成的堆快照。jhat内置了一个微型的HTTP/HTML服务器，生成dump文件的分析结果后，可以在浏览器中查看。

```shell
jhat test.bin
```

### 4.2.6 jstack: Java堆栈跟踪工具

jstack命令用于生成虚拟机当前时刻的线程快照。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程死锁、死循环、请求外部资源导致长时间等待等。

| 选项 | 作用                                         |
| ---- | -------------------------------------------- |
| -F   | 当正常输出的请求不被响应时，强制输出线程堆栈 |
| -I   | 除堆栈外，显示关于锁的附加信息               |
| -m   | 如果调用到本地方法的话，可以显示c/c++的堆栈  |

### 4.2.7 HSDIS: JIT生成代码反汇编

## 4.3 JDK的可视化工具

### 4.3.1 JConsole: Java监视与管理控制台

#### 1.监控远程程序

需要添加如下参数，启动程序即可。

如果为tomcat，则在catalina.sh配置文件增加如下配置信息:

```shell
-Djava.rmi.server.hostname=192.168.1.1 \
-Dcom.sun.management.jmxremote \
-Dcom.sun.management.jmxremote.port=12312 \
-Dcom.sun.management.jmxremote.authenticate=false \
-Dcom.sun.management.jmxremote.ssl=false \
```

```shell
nohup java -jar test.jar --spring.profiles.active=dev > nohup 2>&1 &
```

#### 2. 概览

![Reachability Analysis](https://cdn.jsdelivr.net/gh/Clarencezero/poi/vm gailan.png)

#### 3. 内存

![Reachability Analysis](https://cdn.jsdelivr.net/gh/Clarencezero/poi/vm memory.png)

#### 4. 线程

![Reachability Analysis](https://cdn.jsdelivr.net/gh/Clarencezero/poi/vm thread.png)

#### 5. 类

![Reachability Analysis](https://cdn.jsdelivr.net/gh/Clarencezero/poi/vm class.png)

#### 6. VM概要

### 4.3.2 VisualVM: 多合一故障处理工具

VisualVM 是Netbeans的profile子项目，已在JDK6.0 update 7 中自带，能够监控线程，内存情况，查看方法的CPU时间和内存中的对 象，已被GC的对象，反向查看分配的堆栈(如100个String对象分别由哪几个对象分配出来的)。 

![Reachability Analysis](https://cdn.jsdelivr.net/gh/Clarencezero/poi/jvisualvm detail.png)

![Reachability Analysis](https://cdn.jsdelivr.net/gh/Clarencezero/poi/jvisualvm detail2.png)





































