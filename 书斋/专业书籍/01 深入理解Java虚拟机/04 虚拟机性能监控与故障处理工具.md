# 虚拟机性能监控与故障处理工具

## 4.1 概述

给一个系统定位问题时，知识、经验是关键基础，数据是依据，工具是运用知识处理数据的手段。

这里说的数据包括: 

- 运行日志
- 异常堆栈
- GC日志
- 线程快照(threaddump/javacore文件)
- 堆转储快照(heapdump/hprof)文件

## 4.2 JDK命令行工具

借助toor.jar类库里面的接口,我们可以直接在应用程序中实现功能强大的监控分析功能。

> 注:tools.jar中的类库不属于Java的标准API,如果引入这个类库,就意味着用户的程序只能运行于Sun HotSpot上面,或者部署程序时需要一起部署tools.jar

| **名称** | **主要作用**                                                 |
| -------- | ------------------------------------------------------------ |
| jps      | JVM Process Status Tool,显示指定系统内所有的HotSpot虚拟机进程 |
| jstat    | JVM statistics Monitoring Tool,用于收集HotSpot虚拟机各方面的运行数据 |
| jinfo    | Configuration Info for Java，显示虚拟机配置信息              |
| jmap     | Memory Map for Java，生成虚拟机的内存转储快照（heapdump文件） |
| jhat     | JVM Heap Dump Brower,用于分析heap dump文件，它会建立一个HTTP？HTML服务器，让用户可以在浏览器上查看分析结果 |
| jstack   | Stack Trace for Java。显示虚拟机的线程快照                   |

### 4.2.1 jps: 虚拟机进程状况工具

```shell
jps [options] [hostid]
```

| 属性 | 作用                                               |
| :--: | -------------------------------------------------- |
|  -p  | 只输出LVMID，省略主类的名称                        |
|  -m  | 输出虚拟机进程启动时传递给主类main（）函数的参数   |
|  -l  | 输出主类的全名，如果进程执行的是jar包，输出jar路径 |
|  -v  | 输出虚拟机进程启动时jvm参数                        |

### 4.2.2 jstat: 虚拟机统计信息监视工具

jstat是用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾回收、JIT编译等运行数据，在没有GUI图形界面，只是提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的首选工具。

```shell
jstat [option vmid [interval [s|ms] [count]] ]
# 参数interval 和count分别表示查询的间隔和次数，如果省略这两个参数，说明只查询一次。
```

| 选项              | 作用                                                         |
| :---------------- | ------------------------------------------------------------ |
| -class            | 监视装载类、卸载类、总空间以及类装载所耗费的时间             |
| -gc               | 监视java堆状况，包括eden区、两个survivor区、老年代、永久代等的容量、已用空间、GC时间合计信息 |
| -gccapacity       | 监视内容与-gc基本相同，但输出主要关注java堆各个区域使用到最大、最小空间 |
| -gcutil           | 监视内容与-gc基本相同，但输出主要关注已使用控件占总空间的百分比 |
| -gccause          | 与-gcutil功能一样，但是会额外输出导致上一次gc产生的原因      |
| -gcnew            | 监视新生代GC情况                                             |
| -gcnewcapacity    | 监视内容与-gcnew基本相同，输出主要关注使用到的最大、最小空间 |
| -gcold            | 监视老年代GC情况                                             |
| -gcoldcapacity    | 监视内容与-gcold基本相同，输出主要关注使用到的最大、最小空间 |
| -gcpermcapacity   | 输出永久代使用到的最大、最小空间                             |
| -compiler         | 输出JIT编译过的方法、耗时等信息                              |
| -printcompilation | 输出已经被JIT编译过的方法                                    |

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg .tg-qssw{background-color:#f8a102;text-align:left;vertical-align:top}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
.tg .tg-0lax{text-align:left;vertical-align:top}
.tg .tg-v8n8{background-color:#ffcb2f;border-color:#333333;text-align:left;vertical-align:top}
</style>
<table class="tg">
  <tr>
    <th class="tg-0pky">选项</th>
    <th class="tg-0pky">作用</th>
  </tr>
  <tr>
    <td class="tg-0lax">-class</td>
    <td class="tg-0lax">监视装载类、卸载类、总空间以及类装载所耗费的时间</td>
  </tr>
  <tr>
    <td class="tg-v8n8">-gc</td>
    <td class="tg-v8n8">监视java堆状况，包括eden区、两个survivor区、老年代、永久代等的容量、已用空间、GC时间合计信息</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gccapacity</td>
    <td class="tg-0lax">监视内容与-gc基本相同，但输出主要关注java堆各个区域使用到最大、最小空间</td>
  </tr>
  <tr>
    <td class="tg-qssw">-gcutil</td>
    <td class="tg-qssw">监视内容与-gc基本相同，但输出主要关注已使用控件占总空间的百分比</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gccause</td>
    <td class="tg-0lax">与-gcutil功能一样，但是会额外输出导致上一次gc产生的原因</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gcnew</td>
    <td class="tg-0lax">监视新生代GC情况</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gcnewcapacity</td>
    <td class="tg-0lax">监视内容与-gcnew基本相同，输出主要关注使用到的最大、最小空间</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gcold</td>
    <td class="tg-0lax">监视老年代GC情况</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gcoldcapacity</td>
    <td class="tg-0lax">监视内容与-gcold基本相同，输出主要关注使用到的最大、最小空间</td>
  </tr>
  <tr>
    <td class="tg-0lax">-gcpermcapacity</td>
    <td class="tg-0lax">输出永久代使用到的最大、最小空间</td>
  </tr>
  <tr>
    <td class="tg-0lax">-compiler</td>
    <td class="tg-0lax">输出JIT编译过的方法、耗时等信息</td>
  </tr>
  <tr>
    <td class="tg-0lax">-printcompilation</td>
    <td class="tg-0lax">输出已经被JIT编译过的方法</td>
  </tr>
</table>



### 4.2.3 jinfo: java配置信息工具

### 4.2.4 jmap: Java内存映像工具

### 4.2.5 jhat: 虚拟机堆转储快照分析工具

### 4.2.6 jstack: Java堆栈跟踪工具

### 4.2.7 HSDIS: JIT生成代码反汇编

## 4.3 JDK的可视化工具

### 4.3.1 JConsole: Java监视与管理控制台

### 4.3.2 VisualVM: 多合一故障处理工具











































